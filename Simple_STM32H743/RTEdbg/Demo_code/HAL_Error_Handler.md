# Logging Calls to the STM HAL Error_Handler()

The demo code shows how to log information about the function that called `Error_Handler()` without needing to modify the code generated by the STM32CubeMX code generator.

Programmers use, for example, numeric values or *\_\_FILE\_\_* and *\_\_LINE\_\_* macros or predefined identifiers (e.g., C99 *\_\_func\_\_*) to identify the location of the block in the source file that may be causing a problem (during error reporting). None of this can be used together with the code automatically generated by the STM32CubeMX tools. An example of error handling from the demo project is (see file `main.c`):
```
    if (HAL_RCC_OscConfig(&RCC_OscInitStruct) != HAL_OK)
    {
        Error_Handler();
    }
```

The automaticallly generated error handler is called with no parameters to indicate what has happened or what the cause might be. The link register (LR) contains information about the program location from which the handler was called (program counter value). If this value is known, programmers can identify the source code part from the list file. Logging the LR value is easier than logging the \_\_FILE\_\_/ \_\_LINE\_\_ and uses only 8 bytes of the circular buffer. See below for the modified `Error_Handler()` function from the demo STM32H743 (file `main.c`).

```C
/**
  * @brief  This function is executed in case of error occurrence.
  * @retval None
  */
void Error_Handler(void)
{
  /* USER CODE BEGIN Error_Handler_Debug */
  /* User can add his own implementation to report the HAL error return state */

    // Log the location from which this function has been called
    uint32_t link_reg = (__get_LR() & ~1) - 4;
        // Get the address from which the Error_handler() was called (see the description below)
    RTE_MSG1 (MSG1_ERROR_HANDLER, F_SYSTEM, link_reg)
    shutdown_the_system();
  /* USER CODE END Error_Handler_Debug */
}
```
The link register (LR) information logged by the `RTE_MSG1()` macro is intended for experienced programmers familiar with ARM Cortex assembly language. The address in the LR register is not necessarily the address from which the Error_Handler() function was called. It may be the address of the function that called the error reporting function. In fact, the linker can replace the function call with the Branch with Link command with the Branch command. Also, in cases where there are multiple calls to the `Error_Handler()` function inside a function, the compiler can only insert one call to this function. The LR (link register) value must be logged at the beginning of an error/exception handler - as shown above. If another function is called before `__get_LR()`, the LR value will be overwritten. Such a solution is only possible on CPUs based on a ARM Cortex-M core or other cores that store the return address in a CPU register such as LR.